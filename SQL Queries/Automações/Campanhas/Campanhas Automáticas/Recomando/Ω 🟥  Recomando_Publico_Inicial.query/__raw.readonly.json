{
  "queryDefinitionId": "f28615c9-fcfd-4c6a-b889-b26a465b3662",
  "name": "Recomando_Publico_Inicial",
  "key": "af7651b6-0bb0-4994-aeb1-0e0eaa5dea9c",
  "description": "Gera publico inicial para Jornada de Recomando",
  "queryText": "SELECT\n  BASE.*\nFROM (\n  SELECT\n    RCP.HC_CPF_CNPJ__c as CPF,\n    SELECTED.CAMPAIGNID AS ID_CAMPANHA,\n    SELECTED.CLIENTEPARCEIROID AS ID_CLIENTE_PARCEIRO,\n    SELECTED.CONTACTID AS ID_CONTATO,\n    SELECTED.TITULOID AS ID_TITULO,\n    SELECTED.PAGAMENTOID AS ID_PAGAMENTO,\n    RCP.HC_Nome_Parceiro__c as Parceiro,\n    HC_TIPO_DE_PESSOA__C as TIPO_DE_PESSOA,\n    CASE\n      WHEN RCP.HC_EMAIL_PRINCIPAL__C = 'Brasilcap' THEN HC_EMAIL_BRASILCAP__C\n      WHEN RCP.HC_EMAIL_PRINCIPAL__C = 'Comercial' THEN HC_EMAIL_COMERCIAL__C\n      WHEN RCP.HC_EMAIL_PRINCIPAL__C = 'Pessoal' THEN HC_EMAIL_PESSOAL__C\n      WHEN RCP.HC_EMAIL_BRASILCAP__C IS NOT NULL THEN HC_EMAIL_BRASILCAP__C\n      WHEN RCP.HC_EMAIL_COMERCIAL__C IS NOT NULL THEN HC_EMAIL_COMERCIAL__C\n      WHEN RCP.HC_EMAIL_PESSOAL__C IS NOT NULL THEN HC_EMAIL_PESSOAL__C\n      ELSE NULL\n    END AS EMAIL,\n    CASE\n      WHEN RCP.HC_EMAIL_PRINCIPAL__C IN ('Brasilcap', 'Comercial', 'Pessoal') THEN 1\n      WHEN RCP.HC_EMAIL_BRASILCAP__C IS NOT NULL THEN 1\n      WHEN RCP.HC_EMAIL_COMERCIAL__C IS NOT NULL THEN 1\n      WHEN RCP.HC_EMAIL_PESSOAL__C IS NOT NULL THEN 1\n      ELSE 0\n    END AS EMAIL_VALIDO,\n    CASE\n      WHEN RCP.HC_TELEFONE_PRINCIPAL__C = 'Celular 1' THEN RCP.HC_CELULAR_1__C\n      WHEN RCP.HC_TELEFONE_PRINCIPAL__C = 'Celular 2' THEN RCP.HC_CELULAR_2__C\n      WHEN RCP.HC_TELEFONE_PRINCIPAL__C = 'Celular 3' THEN RCP.HC_CELULAR_3__C\n      WHEN RCP.HC_TELEFONE_PRINCIPAL__C = 'Celular 3_3' THEN RCP.HC_CELULAR_3_3__C\n      WHEN RCP.HC_TELEFONE_PRINCIPAL__C = 'Celular 4' THEN RCP.HC_CELULAR_4__C\n      WHEN RCP.HC_STATUS_CELULAR_1__C IS NOT NULL THEN RCP.HC_CELULAR_1__C\n      WHEN RCP.HC_STATUS_CELULAR_2__C IS NOT NULL THEN RCP.HC_CELULAR_2__C\n      WHEN RCP.HC_STATUS_CELULAR_3__C IS NOT NULL THEN RCP.HC_CELULAR_3__C\n      WHEN RCP.HC_STATUS_CELULAR_3_3__C IS NOT NULL THEN RCP.HC_CELULAR_3_3__C\n      WHEN RCP.HC_STATUS_CELULAR_4__C IS NOT NULL THEN RCP.HC_CELULAR_4__C\n      ELSE NULL\n    END AS CELULAR,\n    CASE\n      WHEN RCP.HC_STATUS_CELULAR_1__C = 'VÁLIDO' THEN 1\n      WHEN RCP.HC_STATUS_CELULAR_2__C = 'VÁLIDO' THEN 1\n      WHEN RCP.HC_STATUS_CELULAR_3__C = 'VÁLIDO' THEN 1\n      WHEN RCP.HC_STATUS_CELULAR_3_3__C = 'VÁLIDO' THEN 1\n      WHEN RCP.HC_STATUS_CELULAR_4__C = 'VÁLIDO' THEN 1\n      ELSE 0\n    END AS CELULAR_VALIDO,\n    GETDATE() + 1 AS DATA_EXECUCAO,\n    PAG.HC_Valor_Liquido__c AS Valor_Liquido,\n    /* PAG.HC_Data_do_pagamento__c,\n    PAG.HC_Data_Envio_Registro__c, */\n    'PT-BR' AS LOCALE,\n    case\n      WHEN RCP.HC_chaveParceiro__c = '52' AND RCP.HC_Tipo_de_Pessoa__c = 'PF' then 'PF OUROCAP'\n      WHEN RCP.HC_chaveParceiro__c = '52' AND RCP.HC_Tipo_de_Pessoa__c = 'PJ' then 'PJ OUROCAP'\n      ELSE 'CAP FIADOR'\n    END AS CAMPAIGN_GROUP,\n    /* evitar repetição de CPFs por campanha */\n\t\tROW_NUMBER() OVER(PARTITION BY CMP.ID ORDER BY RCP.HC_CPF_CNPJ__C ASC) AS ROWNO\n  FROM (\n    SELECT\n      A.ID as CAMPAIGNID,\n      B.ID AS CLIENTEPARCEIROID,\n      C.ID AS CONTACTID,\n      D.ID AS TITULOID,\n      PAG.ID AS PAGAMENTOID,\n      row_number() over (PARTITION BY B.ID, D.ID ORDER BY B.ID) AS NUMBER_OF_CPF_REPETITION\n    FROM CAMPAIGN_SALESFORCE A\n    INNER JOIN HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE B ON 1 = 1\n    INNER JOIN CONTACT_SALESFORCE C ON C.HC_CPF_CNPJ__C = B.HC_CPF_CNPJ__C\n    INNER JOIN HC_TITULO__C_SALESFORCE D ON D.HC_CLIENTE_X_PARCEIRO__C = B.ID\n    INNER JOIN [HC_PAGAMENTO__C_SALESFORCE] PAG ON D.ID = PAG.HC_TITULO__C\n    LEFT JOIN [HISTORICO_QUEDAS] HQ ON HQ.ID_PAGAMENTO = PAG.ID\n    WHERE \n      A.ISACTIVE = 1\n      AND A.PARENTID = '7016g000000NkagAAC'\n        /* Não repetição de comunicação para (pagamento) queda já comunicada */\n      AND HQ.ID_PAGAMENTO IS NULL\n        /* Data de Execução\n      AND CONVERT(VARCHAR(10), A.HC_DATA_DE_EXECUCAO__C, 101) = CONVERT(VARCHAR(10), GETDATE(), 101)\n      AND DATEPART(HH, A.HC_DATA_DE_EXECUCAO__C) = DATEPART(HH, GETDATE())\n        Tipo de cliente controlado pelo registro da campanha no service */\n      AND (B.HC_TIPO_DE_PESSOA__C = A.HC_TIPO_DE_CLIENTE__C OR (A.HC_TIPO_DE_CLIENTE__C = 'PF E PJ' ))\n        /* Tipos de pagamento */\n      AND (PAG.HC_STATUS_DO_PAGAMENTO__C = 'QUEDA' OR PAG.HC_STATUS_DO_PAGAMENTO__C = 'QUEDA DE PRÉVIA')\n        /* PARCEIROS VALIDOS */\n      AND (\n        B.HC_PARCEIRO__C = A.HC_PARCEIRO__C\n        OR (\n          A.HC_PARCEIRO__C IS NULL\n          AND B.HC_ID_PARCEIRO_CAP__C IN ( \n              'VFREI', 'VILAN', 'ACOST', 'ALLEN', 'AMPL', 'ATIVA', 'CCB', 'INTEG', 'JACY', 'KMUL', 'LB ', 'LOCAL', 'MAFRA', 'MCFIL', \n              'METOD', 'METW', 'MILAN', 'MKCOR', 'NSI', 'TOTUM', 'PRIMA', 'REINO', 'SEGES', 'CONC', 'ELEG', 'GARDI',\n              'TRAMP', 'ANAP', 'BARAU', 'JACAR', 'MARKF', 'MARTI', 'MGC', 'MONTP', 'NETI', 'TDA', 'PBCOR', 'PLAN', 'QUEIR', 'R E R', 'ROSI', \n              'SAN', 'SAURA', 'SEGNA', 'CONE', 'GAST', 'GOLF', 'HRD', 'UNIGE', 'VALLI', 'VLVE', 'VPSCG', 'WALT', 'ACOS', 'AFIRM', 'AYUMI', 'BCK', \n              'BGS', 'CIPA', 'JSEG', 'MAC', 'NFEAB', 'NTCOR', 'TKS', 'O2COR', 'PLANE', 'SOUTH', 'DNA', 'DOSC', 'EXPER', 'FEDCO', 'G100', 'GRANL', 'WCSI', '5 S',\n              'AGZ', 'AMAD', 'APSA', 'BLINK', 'BORE', 'BRINS', 'CARME', 'CENER', 'IMOBI', 'MITRA', 'MONIT', 'MPAG', 'NARUD', 'THOMA', 'PROTE', 'PROVE', 'RPOTY', \n              'RRCOR', 'SFCON', 'SIEL', 'SIGMA', 'CODE', 'DACEL', 'GEBR', 'GOBAT', 'GOLDE', 'VARIA', 'VRCOR', 'WJF', '100AL', 'ACDP', 'ACORE', 'CAMBI', 'CANAD', \n              'CCENT', 'CENTR', 'INOVE', 'JOR', 'MANDE', 'MBAC', 'ORBIX', 'PLANJ', 'RENOM', 'ROADS', 'RVERD', 'SCAP', 'SICAR', 'CONF', 'DRESD', 'EGD', 'EXATA', \n              'FIANS', 'GLOBA', 'TRIUN', 'VPSD', 'YOUSG', 'AJSOU', 'ANJOS', 'BCAP', 'BUSIN', 'CALEG', 'CAMIL', 'CDAV', 'JBI', 'JRF', 'MAX', 'MAXC', 'MONRA', 'TCBC', \n              'POLLO', 'REIS', 'SANTA', 'SUCCE', 'CONQU', 'GOLDP', 'UNIC', 'VIEIR', 'VPS', 'VPSDR', 'BASSO', 'BSB', 'JARS', 'JPF', 'LMAT', 'MAIOR', 'MAREC', 'MAXI', \n              'MAXIM', 'MCLA', 'NELOR', 'NOIVA', 'TJVAL', 'ONIX', 'ORGAB', 'PALAV', 'PCAMP', 'PLUS', 'PMG', 'RIOT', 'RIVER', 'ROCHA', 'SECO', 'SEGUR', 'SID', 'SINAC', \n              'SLTLK', 'TAS', 'CONST', 'FAAR', 'GEMP', 'HAMUR', 'HERMA', '100AG', 'ALIKA', 'ALUG', 'CLASP', 'NPIME', 'TOLED', 'RAOS', 'SAMAR', 'SCHAA', 'SEGF', 'SPASI', \n              'STERS', 'DIRET', 'DLEGE', 'EKO', 'EKOBE', 'FERRE', 'GRCAP', 'HASHI', 'HCAM'\n          )\n        )\n      )\n      /* -------- PARAMETROS ESPECIFICOS DA CAMPANHA DE RECOMANDO -------- */\n      /* RANGE DATA */\n      AND (\n        (PAG.HC_Data_Envio_Registro__c >= A.HC_DATA_INICIAL_DO_PERIODO_DE_QUEDA__C OR A.HC_DATA_INICIAL_DO_PERIODO_DE_QUEDA__C IS NULL)\n        AND (PAG.HC_Data_Envio_Registro__c <= A.HC_DATA_FIM_DO_PERIODO_DE_QUEDA__C OR A.HC_DATA_FIM_DO_PERIODO_DE_QUEDA__C IS NULL)\n      )\n      /* RANGE VALOR */\n      AND (\n        (PAG.HC_VALOR_LIQUIDO__C >= A.HC_VALOR_MINIMO_A_PAGAR__C OR A.HC_VALOR_MINIMO_A_PAGAR__C IS NULL)\n        AND (PAG.HC_VALOR_LIQUIDO__C <= A.HC_VALOR_MAXIMO_A_PAGAR__C OR A.HC_VALOR_MAXIMO_A_PAGAR__C IS NULL)\n      )\n      AND (\n        /* Ter e-mail valido */\n        (  B.HC_EMAIL_BRASILCAP__C IS NOT NULL OR B.HC_EMAIL_COMERCIAL__C IS NOT NULL OR B.HC_EMAIL_PESSOAL__C IS NOT NULL )\n        /* ou celular valido */\n        OR ( B.HC_STATUS_CELULAR_1__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_2__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_3__C = 'VÁLIDO' \n          OR B.HC_STATUS_CELULAR_3_3__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_4__C = 'VÁLIDO' )\n      )\n    ) SELECTED\n  INNER JOIN [HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE] RCP ON SELECTED.CLIENTEPARCEIROID = RCP.ID\n  INNER JOIN CAMPAIGN_SALESFORCE CMP ON SELECTED.CAMPAIGNID = CMP.ID\n  INNER JOIN [HC_TITULO__C_SALESFORCE] TIT ON SELECTED.TITULOID = TIT.ID\n  INNER JOIN [HC_Pagamento__c_Salesforce] PAG ON SELECTED.PAGAMENTOID = PAG.ID\n  WHERE SELECTED.NUMBER_OF_CPF_REPETITION = 1\n) BASE\nINNER JOIN\n  CAMPAIGN_SALESFORCE CAMP\n  ON BASE.ID_CAMPANHA = CAMP.ID\nWHERE\n\tCAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C IS NULL\n\tOR BASE.ROWNO <= (CAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C)",
  "targetName": "RECOMANDO_PUBLICO_INICIAL",
  "targetKey": "0CF1F0BD-C93A-44ED-90B1-C3B3D019BED3",
  "targetId": "0f903e80-ebed-ec11-a5b6-d4f5ef66aed7",
  "targetDescription": "Base contendo selecao inicial do publico",
  "createdDate": "2022-06-16T21:32:37.23",
  "modifiedDate": "2022-12-15T18:17:34.14",
  "targetUpdateTypeId": 0,
  "targetUpdateTypeName": "Overwrite",
  "categoryId": 31535,
  "isFrozen": false
}
{
  "queryDefinitionId": "10d4d2eb-6788-472b-8135-95bccea6a6b5",
  "name": "Publico Sorteio dia 18-jul",
  "key": "0e1c6256-e3a2-490e-9c3c-2e34d4d1dac1",
  "description": "",
  "queryText": "SELECT\n  BASE.*\nFROM (\n  SELECT\n    B.HC_CPF_CNPJ__C AS CPF,\n    C.NAME AS NOME,\n    B.HC_NAO_DESEJA_RECEBER_EMAIL__C as NAO_DESEJA_RECEBER_EMAIL,\n    B.HC_NAO_DESEJA_RECEBER_SMS__C as NAO_DESEJA_RECEBER_SMS,\n    CASE\n      WHEN B.HC_EMAIL_PRINCIPAL__C = 'Brasilcap' THEN HC_EMAIL_BRASILCAP__C\n      WHEN B.HC_EMAIL_PRINCIPAL__C = 'Comercial' THEN HC_EMAIL_COMERCIAL__C\n      WHEN B.HC_EMAIL_PRINCIPAL__C = 'Pessoal' THEN HC_EMAIL_PESSOAL__C\n      WHEN B.HC_EMAIL_BRASILCAP__C IS NOT NULL THEN HC_EMAIL_BRASILCAP__C\n      WHEN B.HC_EMAIL_COMERCIAL__C IS NOT NULL THEN HC_EMAIL_COMERCIAL__C\n      WHEN B.HC_EMAIL_PESSOAL__C IS NOT NULL THEN HC_EMAIL_PESSOAL__C\n      ELSE NULL\n    END AS EMAIL,\n    CASE\n      WHEN B.HC_EMAIL_PRINCIPAL__C IN ('Brasilcap', 'Comercial', 'Pessoal') THEN 1\n      WHEN B.HC_EMAIL_BRASILCAP__C IS NOT NULL THEN 1\n      WHEN B.HC_EMAIL_COMERCIAL__C IS NOT NULL THEN 1\n      WHEN B.HC_EMAIL_PESSOAL__C IS NOT NULL THEN 1\n      ELSE 0\n    END AS EMAIL_VALIDO,\n    CASE\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 1' THEN B.HC_CELULAR_1__C\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 2' THEN B.HC_CELULAR_2__C\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 3' THEN B.HC_CELULAR_3__C\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 3_3' THEN B.HC_CELULAR_3_3__C\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 4' THEN B.HC_CELULAR_4__C\n      WHEN B.HC_STATUS_CELULAR_1__C IS NOT NULL THEN B.HC_CELULAR_1__C\n      WHEN B.HC_STATUS_CELULAR_2__C IS NOT NULL THEN B.HC_CELULAR_2__C\n      WHEN B.HC_STATUS_CELULAR_3__C IS NOT NULL THEN B.HC_CELULAR_3__C\n      WHEN B.HC_STATUS_CELULAR_3_3__C IS NOT NULL THEN B.HC_CELULAR_3_3__C\n      WHEN B.HC_STATUS_CELULAR_4__C IS NOT NULL THEN B.HC_CELULAR_4__C\n      ELSE NULL\n    END AS CELULAR,\n    CASE\n      WHEN B.HC_STATUS_CELULAR_1__C = 'VÁLIDO' THEN 1\n      WHEN B.HC_STATUS_CELULAR_2__C = 'VÁLIDO' THEN 1\n      WHEN B.HC_STATUS_CELULAR_3__C = 'VÁLIDO' THEN 1\n      WHEN B.HC_STATUS_CELULAR_3_3__C = 'VÁLIDO' THEN 1\n      WHEN B.HC_STATUS_CELULAR_4__C = 'VÁLIDO' THEN 1\n      ELSE 0\n    END AS CELULAR_VALIDO,\n    A.ID AS ID_CAMPANHA, \n    B.ID AS ID_CLIENTE_PARCEIRO,\n    C.ID AS ID_CONTATO,\n    D.ID AS ID_TITULO,\n    'BR' as Locale,\n    A.HC_Mes_Inicio__c,\n    A.HC_Mes_Fim__c,\n    A.HC_Quantidade_de_clientes_sorteados__c,\n    A.HC_Valor_do_premio__c,\n      Sorteio,\n    Premio_Email,\n    Descricao,\n    format(convert(datetime, '2022-07-18'), 'dd/MM/yyyy', 'pt-br') as Data_Envio,\n    format(dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18')), 'dd/MM/yyyy', 'pt-br') as Data_Sorteio,\n    ROW_NUMBER() OVER(ORDER BY B.HC_CPF_CNPJ__C ASC) AS ROWNO\n  FROM (\n    SELECT\n      A.ID as CAMPAIGNID,\n      B.ID AS CLIENTEPARCEIROID,\n      C.ID AS CONTACTID,\n      D.ID AS TITULOID,\n      [Dispara dias antes],\n      Sorteio,\n    Premio_Email,\n    Descricao,\n      row_number() over (PARTITION BY B.HC_CPF_CNPJ__C, D.ID ORDER BY B.ID) AS ROW\n    FROM CAMPAIGN_SALESFORCE A\n    INNER JOIN HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE B ON 1 = 1\n    INNER JOIN CONTACT_SALESFORCE C ON C.HC_CPF_CNPJ__C = B.HC_CPF_CNPJ__C\n    INNER JOIN HC_TITULO__C_SALESFORCE D ON D.HC_CLIENTE_X_PARCEIRO__C = B.ID\n    INNER JOIN PRE_SORTEIO_RELACAO_PLANOS PLANOS ON PLANOS.PLANO = D.HC_PLANO__C\n    where \n      /* ------- CONFIG DA CAMPANHA ------- */\n      A.ID = '7016g0000007jtXAAQ'\n          /* Data de Execução */\n      /* AND CONVERT(VARCHAR(10), A.HC_DATA_DE_EXECUCAO__C, 101) = CONVERT(VARCHAR(10), convert(datetime, '2022-07-18'), 101) */\n      /* AND DATEPART(HH, A.HC_DATA_DE_EXECUCAO__C) = DATEPART(HH, convert(datetime, '2022-07-18')) */\n        /* Tipo de cliente controlado pela campanha */\n      AND (B.HC_TIPO_DE_PESSOA__C = A.HC_TIPO_DE_CLIENTE__C OR (A.HC_TIPO_DE_CLIENTE__C = 'PF E PJ' ))\n      /* ------- CONFIG DE TITULO ------- */\n      AND D.HC_SITUACAO__C = 'ATIVO'\n      /*  and data_sorteio (paramatrizar na campanha) <= d.HC_Fim_previsto__c */\n      /* ------- CONFIG DE CLIENTE PARCEIRO ------- */\n      AND B.HC_NAO_DESEJA_RECEBER_TODOS_MEIOS__C = 0\n      AND (ISNULL(B.HC_NAO_IMPORTUNE__C, 0) = 0 OR A.HC_VALIDA_NAO_IMPORTUNE__C = 0)\n        /* Pode receber comunicação por algum canal (E-mail ou SMS) */\n      AND (\n        /* Pode receber e-mail */\n        ( ISNULL(B.HC_NAO_DESEJA_RECEBER_EMAIL__C, 0) = 0 AND ( B.HC_EMAIL_BRASILCAP__C IS NOT NULL OR B.HC_EMAIL_COMERCIAL__C IS NOT NULL OR B.HC_EMAIL_PESSOAL__C IS NOT NULL ) )\n        /* ou pode receber sms */\n        OR ( ISNULL(B.HC_NAO_DESEJA_RECEBER_SMS__C, 0) = 0 AND (B.HC_STATUS_CELULAR_1__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_2__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_3__C = 'VÁLIDO' \n          OR B.HC_STATUS_CELULAR_3_3__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_4__C = 'VÁLIDO') )\n      )\n      AND B.HC_CLASSIFICACAO__C = 'Cliente'\n      AND B.HC_PARCEIRO__C = A.HC_PARCEIRO__C\n      /* LOGICA DE DISPARO */\n        /* dia da semana do dia de disparo (hoje + dias de disparo anterior informado na base) = dia da semana desejaado para disparo  */\n      AND format(dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18')), 'dddd') = [Dia da semana]\n        /* mes da execucao */\n      AND (\n        (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 1 AND JANEIRO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 2 AND FEVEREIRO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 3 AND MARCO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 4 AND ABRIL = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 5 AND MAIO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 6 AND JUNHO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 7 AND JULHO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 8 AND AGOSTO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 9 AND SETEMBRO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 10 AND OUTUBRO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 11 AND NOVEMBRO = 1)\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) = 12 AND DEZEMBRO = 1)\n      )\n      AND (\n        /* ou NÃO ocorre apenas na primeira semana */\n        (\n          Ocorre_Apenas_Na_Primeira_Semana = 0\n        )\n        /* Ou a data é na primeira semana */\n        OR (\n          Ocorre_Apenas_Na_Primeira_Semana = 1\n          AND DATEPART(dd, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-18'))) <= 7\n        )\n      )\n    ) SELECTED\n    INNER JOIN CAMPAIGN_SALESFORCE A ON SELECTED.CAMPAIGNID = A.ID\n    INNER JOIN HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE B ON SELECTED.CLIENTEPARCEIROID = B.ID\n    INNER JOIN CONTACT_SALESFORCE C ON SELECTED.CONTACTID = C.ID\n    INNER JOIN HC_TITULO__C_SALESFORCE D ON SELECTED.TITULOID = D.ID\n  WHERE SELECTED.ROW = 1\n) BASE\nINNER JOIN\n  CAMPAIGN_SALESFORCE CAMP\n  ON BASE.ID_CAMPANHA = CAMP.ID\nWHERE\n\tCAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C IS NULL\n\tOR BASE.ROWNO <= (CAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C)",
  "targetName": "Tb_Pre_Sorteio_Validacao",
  "targetKey": "11C4ECB3-28CF-4C99-9A7D-4845EE26DB7A",
  "targetId": "47c3848d-8ef6-ec11-a5b6-d4f5ef66aed7",
  "targetDescription": "Validacao",
  "createdDate": "2022-06-27T21:18:06.63",
  "modifiedDate": "2022-06-27T21:26:27.413",
  "targetUpdateTypeId": 1,
  "targetUpdateTypeName": "Update",
  "categoryId": 50718,
  "isFrozen": false
}
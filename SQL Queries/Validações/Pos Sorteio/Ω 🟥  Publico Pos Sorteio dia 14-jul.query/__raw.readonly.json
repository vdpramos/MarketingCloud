{
  "queryDefinitionId": "f56e51e6-4f8a-48c1-a1f1-a5587f58aa2d",
  "name": "Publico Pos Sorteio dia 14-jul",
  "key": "b3381ed7-a9cf-43db-b061-a966844fb44f",
  "description": "Geração do publico para validação que vai receber a comunicação de pos sorteio na data 2022-07-14",
  "queryText": "SELECT\r\n  BASE.*\r\nFROM (\r\n  SELECT\r\n    B.HC_CPF_CNPJ__C AS CPF,\r\n    C.NAME AS NOME,\r\n    B.HC_NAO_DESEJA_RECEBER_EMAIL__C as NAO_DESEJA_RECEBER_EMAIL,\r\n    B.HC_NAO_DESEJA_RECEBER_SMS__C as NAO_DESEJA_RECEBER_SMS,\r\n    CASE\r\n      WHEN B.HC_EMAIL_PRINCIPAL__C = 'Brasilcap' THEN HC_EMAIL_BRASILCAP__C\r\n      WHEN B.HC_EMAIL_PRINCIPAL__C = 'Comercial' THEN HC_EMAIL_COMERCIAL__C\r\n      WHEN B.HC_EMAIL_PRINCIPAL__C = 'Pessoal' THEN HC_EMAIL_PESSOAL__C\r\n      WHEN B.HC_EMAIL_BRASILCAP__C IS NOT NULL THEN HC_EMAIL_BRASILCAP__C\r\n      WHEN B.HC_EMAIL_COMERCIAL__C IS NOT NULL THEN HC_EMAIL_COMERCIAL__C\r\n      WHEN B.HC_EMAIL_PESSOAL__C IS NOT NULL THEN HC_EMAIL_PESSOAL__C\r\n      ELSE NULL\r\n    END AS EMAIL,\r\n    CASE\r\n      WHEN B.HC_EMAIL_PRINCIPAL__C IN ('Brasilcap', 'Comercial', 'Pessoal') THEN 1\r\n      WHEN B.HC_EMAIL_BRASILCAP__C IS NOT NULL THEN 1\r\n      WHEN B.HC_EMAIL_COMERCIAL__C IS NOT NULL THEN 1\r\n      WHEN B.HC_EMAIL_PESSOAL__C IS NOT NULL THEN 1\r\n      ELSE 0\r\n    END AS EMAIL_VALIDO,\r\n    CASE\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 1' THEN B.HC_CELULAR_1__C\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 2' THEN B.HC_CELULAR_2__C\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 3' THEN B.HC_CELULAR_3__C\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 3_3' THEN B.HC_CELULAR_3_3__C\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 4' THEN B.HC_CELULAR_4__C\r\n      WHEN B.HC_STATUS_CELULAR_1__C IS NOT NULL THEN B.HC_CELULAR_1__C\r\n      WHEN B.HC_STATUS_CELULAR_2__C IS NOT NULL THEN B.HC_CELULAR_2__C\r\n      WHEN B.HC_STATUS_CELULAR_3__C IS NOT NULL THEN B.HC_CELULAR_3__C\r\n      WHEN B.HC_STATUS_CELULAR_3_3__C IS NOT NULL THEN B.HC_CELULAR_3_3__C\r\n      WHEN B.HC_STATUS_CELULAR_4__C IS NOT NULL THEN B.HC_CELULAR_4__C\r\n      ELSE NULL\r\n    END AS CELULAR,\r\n    CASE\r\n      WHEN B.HC_STATUS_CELULAR_1__C = 'VÁLIDO' THEN 1\r\n      WHEN B.HC_STATUS_CELULAR_2__C = 'VÁLIDO' THEN 1\r\n      WHEN B.HC_STATUS_CELULAR_3__C = 'VÁLIDO' THEN 1\r\n      WHEN B.HC_STATUS_CELULAR_3_3__C = 'VÁLIDO' THEN 1\r\n      WHEN B.HC_STATUS_CELULAR_4__C = 'VÁLIDO' THEN 1\r\n      ELSE 0\r\n    END AS CELULAR_VALIDO,\r\n    A.ID AS ID_CAMPANHA, \r\n    B.ID AS ID_CLIENTE_PARCEIRO,\r\n    C.ID AS ID_CONTATO,\r\n    D.ID AS ID_TITULO,\r\n    'BR' as Locale,\r\n    A.HC_Mes_Inicio__c,\r\n    A.HC_Mes_Fim__c,\r\n    A.HC_Quantidade_de_clientes_sorteados__c,\r\n    A.HC_Valor_do_premio__c,\r\n    Sorteio,\r\n    Premio_Email,\r\n    Descricao,\r\n    format(convert(datetime, '2022-07-14'), 'dd/MM/yyyy', 'pt-br') as Data_Envio,\r\n    format(dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14')), 'dd/MM/yyyy', 'pt-br') as Data_Sorteio,\r\n    ROW_NUMBER() OVER(ORDER BY B.HC_CPF_CNPJ__C ASC) AS ROWNO\r\n  FROM (\r\n    SELECT\r\n      A.ID as CAMPAIGNID,\r\n      B.ID AS CLIENTEPARCEIROID,\r\n      C.ID AS CONTACTID,\r\n      D.ID AS TITULOID,\r\n      [Dispara dias antes],\r\n      Sorteio,\r\n      Premio_Email,\r\n      Descricao,\r\n      row_number() over (PARTITION BY B.HC_CPF_CNPJ__C, D.ID ORDER BY B.ID) AS ROW\r\n    FROM CAMPAIGN_SALESFORCE A\r\n    INNER JOIN HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE B ON 1 = 1\r\n    INNER JOIN CONTACT_SALESFORCE C ON C.HC_CPF_CNPJ__C = B.HC_CPF_CNPJ__C\r\n    INNER JOIN HC_TITULO__C_SALESFORCE D ON D.HC_CLIENTE_X_PARCEIRO__C = B.ID\r\n    INNER JOIN POS_SORTEIO_RELACAO_PLANOS PLANOS ON PLANOS.PLANO = D.HC_PLANO__C\r\n    where \r\n      /* ------- CONFIG DA CAMPANHA ------- */\r\n      A.ID = '7016g000000TdvVAAS'\r\n          /* Data de Execução */\r\n      /* AND CONVERT(VARCHAR(10), A.HC_DATA_DE_EXECUCAO__C, 101) = CONVERT(VARCHAR(10), convert(datetime, '2022-07-14'), 101) */\r\n      /* AND DATEPART(HH, A.HC_DATA_DE_EXECUCAO__C) = DATEPART(HH, convert(datetime, '2022-07-14')) */\r\n        /* Tipo de cliente controlado pela campanha */\r\n      AND (B.HC_TIPO_DE_PESSOA__C = A.HC_TIPO_DE_CLIENTE__C OR (A.HC_TIPO_DE_CLIENTE__C = 'PF E PJ' ))\r\n      /* ------- CONFIG DE TITULO ------- */\r\n      AND D.HC_SITUACAO__C = 'ATIVO'\r\n      /*  and data_sorteio (paramatrizar na campanha) <= d.HC_Fim_previsto__c */\r\n      /* ------- CONFIG DE CLIENTE PARCEIRO ------- */\r\n      AND B.HC_NAO_DESEJA_RECEBER_TODOS_MEIOS__C = 0\r\n      AND (ISNULL(B.HC_NAO_IMPORTUNE__C, 0) = 0 OR A.HC_VALIDA_NAO_IMPORTUNE__C = 0)\r\n        /* Pode receber comunicação por algum canal (E-mail ou SMS) */\r\n      AND (\r\n        /* Pode receber e-mail */\r\n        ( ISNULL(B.HC_NAO_DESEJA_RECEBER_EMAIL__C, 0) = 0 AND ( B.HC_EMAIL_BRASILCAP__C IS NOT NULL OR B.HC_EMAIL_COMERCIAL__C IS NOT NULL OR B.HC_EMAIL_PESSOAL__C IS NOT NULL ) )\r\n        /* ou pode receber sms */\r\n        OR ( ISNULL(B.HC_NAO_DESEJA_RECEBER_SMS__C, 0) = 0 AND (B.HC_STATUS_CELULAR_1__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_2__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_3__C = 'VÁLIDO' \r\n          OR B.HC_STATUS_CELULAR_3_3__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_4__C = 'VÁLIDO') )\r\n      )\r\n      AND B.HC_CLASSIFICACAO__C = 'Cliente'\r\n      AND B.HC_PARCEIRO__C = A.HC_PARCEIRO__C\r\n      /* LOGICA DE DISPARO */\r\n        /* dia da semana do dia de disparo (hoje + dias de disparo anterior informado na base) = dia da semana desejaado para disparo  */\r\n      AND format(dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14')), 'dddd') = [Dia da semana]\r\n        /* mes da execucao */\r\n      AND (\r\n        (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 1 AND JANEIRO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 2 AND FEVEREIRO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 3 AND MARCO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 4 AND ABRIL = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 5 AND MAIO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 6 AND JUNHO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 7 AND JULHO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 8 AND AGOSTO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 9 AND SETEMBRO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 10 AND OUTUBRO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 11 AND NOVEMBRO = 1)\r\n        OR (DATEPART(month, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) = 12 AND DEZEMBRO = 1)\r\n      )\r\n      AND (\r\n        /* ou NÃO ocorre apenas na primeira semana */\r\n        (\r\n          Ocorre_Apenas_Na_Primeira_Semana = 0\r\n        )\r\n        /* Ou a data é na primeira semana */\r\n        OR (\r\n          Ocorre_Apenas_Na_Primeira_Semana = 1\r\n          AND DATEPART(dd, dateadd(dd, [Dispara dias antes], convert(datetime, '2022-07-14'))) <= 7\r\n        )\r\n      )\r\n    ) SELECTED\r\n    INNER JOIN CAMPAIGN_SALESFORCE A ON SELECTED.CAMPAIGNID = A.ID\r\n    INNER JOIN HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE B ON SELECTED.CLIENTEPARCEIROID = B.ID\r\n    INNER JOIN CONTACT_SALESFORCE C ON SELECTED.CONTACTID = C.ID\r\n    INNER JOIN HC_TITULO__C_SALESFORCE D ON SELECTED.TITULOID = D.ID\r\n  WHERE SELECTED.ROW = 1\r\n) BASE\r\nINNER JOIN\r\n  CAMPAIGN_SALESFORCE CAMP\r\n  ON BASE.ID_CAMPANHA = CAMP.ID\r\nWHERE\r\n\tCAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C IS NULL\r\n\tOR BASE.ROWNO <= (CAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C)",
  "targetName": "Tb_Pos_Sorteio_Validacao",
  "targetKey": "E5FA0959-1F5C-47D3-B28B-EAB275274F20",
  "targetId": "b6c8a30e-3ffd-ec11-a5b6-d4f5ef66aed7",
  "targetDescription": "Validacao",
  "createdDate": "2022-07-06T10:59:51.207",
  "modifiedDate": "2022-07-06T10:59:51.207",
  "targetUpdateTypeId": 1,
  "targetUpdateTypeName": "Update",
  "categoryId": 50969,
  "isFrozen": false
}
{
  "queryDefinitionId": "768a6e12-ad08-4233-810b-6ba09ee6da0b",
  "name": "Nova_Qr00_Base_Ex-Cliente_ComOTC_Filtrada_Algar",
  "key": "5aefde56-d43e-4ff7-a95e-deac772fd38a",
  "description": "Seleciona o público alvo inicial e inclui as informações na DE\n",
  "queryText": "SELECT\n\tBASE.*\nFROM (\n\tSELECT DISTINCT\n\t\tB.HC_CPF_CNPJ__C AS CPF_CNPJ,\n\t\tACC.NAME AS NOME,\n\t\tACC.HC_IDADE__C AS IDADE,\n\t\tHC_DATA_DE_NASCIMENTO__C AS DT_NASCIMENTO,\n\t\tHC_GENERO_DO_CLIENTE__C AS SEXO,\n\t\tCASE \n\t\t\tWHEN UPPER(B.HC_ENDERECO_PRINCIPAL__C) = 'RESIDENCIAL' THEN HC_CEP_RES__C\n\t\t\tWHEN UPPER(B.HC_ENDERECO_PRINCIPAL__C) = 'COMERCIAL' THEN HC_CEP_COM__C\n\t\t\tWHEN UPPER(B.HC_ENDERECO_PRINCIPAL__C) = 'CORRESPONDÊNCIA' THEN HC_CEP_COR__C\n\t\tEND AS CEP,\n\t\tACC.HC_TIPO_DE_PESSOA__C AS TIPO_PESSOA,\n\t\tLEFT(REPLACE(REPLACE(REPLACE(REPLACE(HC_TELEFONE_RESIDENCIAL__C, '(', ''), ')', ''), ' ', ''), '-', ''), 2) AS DDD_TEL_01,\n\t\tSUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(HC_TELEFONE_RESIDENCIAL__C, '(', ''), ')', ''), ' ', ''), '-', ''), 3, 9) AS TEL_01,\n\t\t'FIXO' AS TIPO_TEL_01,\n\t\tLEFT(REPLACE(REPLACE(REPLACE(REPLACE(HC_TELEFONE_COMERCIAL__C, '(', ''), ')', ''), ' ', ''), '-', ''), 2) AS DDD_TEL_02,\n\t\tSUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(HC_TELEFONE_COMERCIAL__C, '(', ''), ')', ''), ' ', ''), '-', ''), 3, 9) AS TEL_02,\n\t\t'FIXO' AS TIPO_TEL_02,\n\t\tLEFT(REPLACE(REPLACE(REPLACE(REPLACE(HC_TELEFONE_OUTRO__C, '(', ''), ')', ''), ' ', ''), '-', ''), 2) AS DDD_TEL_03,\n\t\tSUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(HC_TELEFONE_OUTRO__C, '(', ''), ')', ''), ' ', ''), '-', ''), 3, 9) AS TEL_03,\n\t\t'FIXO' AS TIPO_TEL_03,\n\t\tLEFT(REPLACE(REPLACE(REPLACE(REPLACE(HC_CELULAR_1__C, '(', ''), ')', ''), ' ', ''), '-', ''), 2) AS DDD_TEL_04,\n\t\tSUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(HC_CELULAR_1__C, '(', ''), ')', ''), ' ', ''), '-', ''), 3, 9) AS TEL_04,\n\t\t'MÓVEL' AS TIPO_TEL_04,\n\t\tLEFT(REPLACE(REPLACE(REPLACE(REPLACE(HC_CELULAR_2__C, '(', ''), ')', ''), ' ', ''), '-', ''), 2) AS DDD_TEL_05,\n\t\tSUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(HC_CELULAR_2__C, '(', ''), ')', ''), ' ', ''), '-', ''), 3, 9) AS TEL_05,\n\t\t'MÓVEL' AS TIPO_TEL_05,\n\t\tLEFT(REPLACE(REPLACE(REPLACE(REPLACE(HC_CELULAR_3__C, '(', ''), ')', ''), ' ', ''), '-', ''), 2) AS DDD_TEL_06,\n\t\tSUBSTRING(REPLACE(REPLACE(REPLACE(REPLACE(HC_CELULAR_3__C, '(', ''), ')', ''), ' ', ''), '-', ''), 3, 9) AS TEL_06,\n\t\t'MÓVEL' AS TIPO_TEL_06,\n\t\tHC_TELEFONE_PRINCIPAL__C AS TEL_PRINCIPAL,\n\t\tB.HC_CLASSIFICACAO__C AS PUBLICO_ALVO,\n\t\tA.[TYPE] AS TIPO_CAMPANHA,\n\t\tA.STARTDATE AS DT_INICIO_MAILING,\n\t\tA.ENDDATE AS DT_FIM_MAILING,\n\t\tA.HC_VALIDA_ALTA_RENDA__C AS CAMPANHA_VALIDA_ENCARTEIRAMENTO,\n\t\tA.HC_VALIDA_NAO_IMPORTUNE__C AS CAMPANHA_NAO_IMPORTUNE,\n\t\tA.HC_VALIDA_RNA__C AS CAMPANHA_VALIDA_RNA,\n\t\tA.HC_PRODUTO__C AS ID_PRODUTO,\n\t\tA.HC_PRECO_DO_PRODUTO__C AS ID_PRODUTO_VALOR,\n\t\tB.HC_CPF_CNPJ__C AS ID,\n\t\tA.ID AS ID_CAMPANHA, \n\t\tB.ID AS ID_CLIENTE_PARCEIRO,\n\t\tC.ID AS ID_CONTATO,\n\t\tB.HC_CPF_CNPJ_CODIGO_PARCEIRO_UNICO__C AS CPF_CNPJ_CODIGO_DO_PARCEIRO,\n\t\tCASE WHEN HC_Conta_Principal__c = 'CONTA 1' AND HC_Tipo_da_Conta_1__c = 'Conta Corrente' THEN 'CONTA 1'\n\t\t\t WHEN HC_Conta_Principal__c = 'CONTA 2' AND HC_Tipo_da_Conta_2__c = 'Conta Corrente' THEN 'CONTA 2'\n\t\t\t WHEN HC_Tipo_da_Conta_1__c = 'Conta Corrente' AND HC_Tipo_da_Conta_2__c = 'Conta Poupança' THEN 'CONTA 1'\n\t\t\t WHEN HC_Tipo_da_Conta_2__c = 'Conta Corrente' AND HC_Tipo_da_Conta_1__c = 'Conta Poupança' THEN 'CONTA 2'\n\t\t\t ELSE 'ERRO' END AS CONTA_BANCARIA,\n\t\tCASE WHEN CHARINDEX('&', C.NAME, 0) = 0 THEN 1 ELSE 0 END AS NOME_VALIDA,\n\t\tROW_NUMBER() OVER(ORDER BY B.ID ASC) AS ROWNO\n  FROM (\n    SELECT\n      A.ID AS CAMPAIGN_ID,\n      B.ID AS RELACAO_CLIENTE_PARCEIRO_ID,\n      C.ID AS CONTACT_ID,\n      T.ID AS TITULO_ID,\n      ACC.ID AS ACCOUNT_ID,\n      ROW_NUMBER() OVER(PARTITION BY B.ID ORDER BY B.ID ASC) AS NUMBER_OF_CPF_REPETITION\n    FROM CAMPAIGN_SALESFORCE A\n    INNER JOIN HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE B ON A.HC_PARCEIRO__C = B.HC_PARCEIRO__C\n                                AND A.[TYPE] = B.HC_CLASSIFICACAO__C\n                                AND B.HC_TIPO_DE_PESSOA__C = 'PF'\n    INNER JOIN Contact_Salesforce C ON C.HC_CPF_CNPJ__c = B.HC_CPF_CNPJ__c\n    INNER JOIN HC_Titulo__c_Salesforce T ON B.HC_CPF_CNPJ__c = T.HC_CPF_CNPJ_Titular__c\n    INNER JOIN Account_Salesforce ACC ON C.AccountId = ACC.Id\n    LEFT JOIN HC_PROPOSTA__C_SALESFORCE P ON P.HC_CPF_CNPJ_TITULAR__C = B.HC_CPF_CNPJ__C \n      AND DATEDIFF(DAY, CONVERT(CHAR(10), P.CREATEDDATE, 112), CONVERT(CHAR(10), GETDATE(), 112)) <= A.HC_COMPRA_RECENTE__C \n    WHERE\n      A.[TYPE] = 'Ex-Cliente'\n    AND P.HC_CPF_CNPJ_TITULAR__C IS NULL\n    AND A.HC_FORMATO__C = 'Offline'\n    AND A.HC_FORNECEDOR__C = 'Algar'\n\t\tAND B.HC_CONSELHEIRO__C = 0\n\t\tAND B.HC_PEP__C = 0\n\t\tAND B.HC_NAO_DESEJA_RECEBER_LIGACOES__C = 0\n\t\tAND B.HC_NAO_DESEJA_RECEBER_TODOS_MEIOS__C = 0\n\t\tAND B.HC_IDADE__C BETWEEN 18 AND 70\n\t\tAND ACC.HC_TIPO_DE_PESSOA__C = 'PF'\n\t\tAND (\n\t\t\t(HC_Conta_Principal__c = 'CONTA 1' AND HC_Tipo_da_Conta_1__c = 'Conta Corrente')\n\t\t\tOR (HC_Conta_Principal__c = 'CONTA 2' AND HC_Tipo_da_Conta_2__c = 'Conta Corrente')\n\t\t\tOR (HC_Tipo_da_Conta_1__c = 'Conta Corrente' AND HC_Tipo_da_Conta_2__c = 'Conta Poupança')\n\t\t\tOR (HC_Tipo_da_Conta_2__c = 'Conta Corrente' AND HC_Tipo_da_Conta_1__c = 'Conta Poupança')\n\t\t)\t\t\t \n  ) FILTERED\n  INNER JOIN CAMPAIGN_SALESFORCE A ON A.ID = FILTERED.CAMPAIGN_ID\n  INNER JOIN HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE B ON B.ID = FILTERED.RELACAO_CLIENTE_PARCEIRO_ID\n  INNER JOIN Contact_Salesforce C ON C.ID = FILTERED.CONTACT_ID\n  INNER JOIN HC_Titulo__c_Salesforce T ON T.ID = FILTERED.TITULO_ID\n  INNER JOIN Account_Salesforce ACC ON ACC.ID = FILTERED.ACCOUNT_ID\n  WHERE FILTERED.NUMBER_OF_CPF_REPETITION = 1\n) BASE\nINNER JOIN\n  CAMPAIGN_SALESFORCE CAMP \n  ON BASE.ID_CAMPANHA = CAMP.ID\nWHERE\n\tCAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C IS NULL\n\tOR BASE.ROWNO <= CAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C",
  "targetName": "Tb_Base_Ex_Cliente_ComOTC_Algar",
  "targetKey": "41E39D78-91F4-4C72-8D32-5A92DAB4234F",
  "targetId": "b549c35b-8a82-eb11-a2fd-48df370eabe5",
  "targetDescription": "",
  "createdDate": "2022-01-26T10:03:31.693",
  "modifiedDate": "2022-01-26T10:03:31.693",
  "targetUpdateTypeId": 1,
  "targetUpdateTypeName": "Update",
  "categoryId": 30784,
  "isFrozen": false
}
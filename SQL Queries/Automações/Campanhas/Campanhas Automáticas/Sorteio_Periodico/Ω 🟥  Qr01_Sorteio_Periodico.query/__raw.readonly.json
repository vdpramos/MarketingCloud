{
  "queryDefinitionId": "b0a0b910-075e-4ac2-b63b-8bc5d643f555",
  "name": "Qr01_Sorteio_Periodico",
  "key": "80ad43d7-c0a3-4ac8-adec-d6de944a53e4",
  "description": "Seleciona o publico inicial com os dados do service",
  "queryText": "SELECT\r\n  BASE.*\r\nFROM (\r\n  SELECT\r\n    B.HC_CPF_CNPJ__C AS CPF_CNPJ,\r\n    C.NAME AS NOME,\r\n    B.HC_NAO_DESEJA_RECEBER_EMAIL__C as NAO_DESEJA_RECEBER_EMAIL,\r\n    B.HC_NAO_DESEJA_RECEBER_SMS__C as NAO_DESEJA_RECEBER_SMS,\r\n    CASE\r\n      WHEN B.HC_EMAIL_PRINCIPAL__C = 'Brasilcap' THEN HC_EMAIL_BRASILCAP__C\r\n      WHEN B.HC_EMAIL_PRINCIPAL__C = 'Comercial' THEN HC_EMAIL_COMERCIAL__C\r\n      WHEN B.HC_EMAIL_PRINCIPAL__C = 'Pessoal' THEN HC_EMAIL_PESSOAL__C\r\n      WHEN B.HC_EMAIL_BRASILCAP__C IS NOT NULL THEN HC_EMAIL_BRASILCAP__C\r\n      WHEN B.HC_EMAIL_COMERCIAL__C IS NOT NULL THEN HC_EMAIL_COMERCIAL__C\r\n      WHEN B.HC_EMAIL_PESSOAL__C IS NOT NULL THEN HC_EMAIL_PESSOAL__C\r\n      ELSE NULL\r\n    END AS EMAIL,\r\n    CASE\r\n      WHEN B.HC_EMAIL_PRINCIPAL__C IN ('Brasilcap', 'Comercial', 'Pessoal') THEN 1\r\n      WHEN B.HC_EMAIL_BRASILCAP__C IS NOT NULL THEN 1\r\n      WHEN B.HC_EMAIL_COMERCIAL__C IS NOT NULL THEN 1\r\n      WHEN B.HC_EMAIL_PESSOAL__C IS NOT NULL THEN 1\r\n      ELSE 0\r\n    END AS EMAIL_VALIDO,\r\n    CASE\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 1' THEN B.HC_CELULAR_1__C\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 2' THEN B.HC_CELULAR_2__C\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 3' THEN B.HC_CELULAR_3__C\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 3_3' THEN B.HC_CELULAR_3_3__C\r\n      WHEN B.HC_TELEFONE_PRINCIPAL__C = 'Celular 4' THEN B.HC_CELULAR_4__C\r\n      WHEN B.HC_STATUS_CELULAR_1__C IS NOT NULL THEN B.HC_CELULAR_1__C\r\n      WHEN B.HC_STATUS_CELULAR_2__C IS NOT NULL THEN B.HC_CELULAR_2__C\r\n      WHEN B.HC_STATUS_CELULAR_3__C IS NOT NULL THEN B.HC_CELULAR_3__C\r\n      WHEN B.HC_STATUS_CELULAR_3_3__C IS NOT NULL THEN B.HC_CELULAR_3_3__C\r\n      WHEN B.HC_STATUS_CELULAR_4__C IS NOT NULL THEN B.HC_CELULAR_4__C\r\n      ELSE NULL\r\n    END AS CELULAR,\r\n    CASE\r\n      WHEN B.HC_STATUS_CELULAR_1__C = 'VÁLIDO' THEN 1\r\n      WHEN B.HC_STATUS_CELULAR_2__C = 'VÁLIDO' THEN 1\r\n      WHEN B.HC_STATUS_CELULAR_3__C = 'VÁLIDO' THEN 1\r\n      WHEN B.HC_STATUS_CELULAR_3_3__C = 'VÁLIDO' THEN 1\r\n      WHEN B.HC_STATUS_CELULAR_4__C = 'VÁLIDO' THEN 1\r\n      ELSE 0\r\n    END AS CELULAR_VALIDO,\r\n    B.HC_TELEFONE_PRINCIPAL__C AS TEL_PRINCIPAL,\r\n    B.HC_CPF_CNPJ__C AS ID,\r\n    A.ID AS ID_CAMPANHA, \r\n    B.ID AS ID_CLIENTE_PARCEIRO,\r\n    C.ID AS ID_CONTATO,\r\n    B.HC_CLIENTE__C AS ID_CLIENTE,\r\n    B.HC_CPF_CNPJ_CODIGO_DO_PARCEIRO__C AS CPF_CNPJ_CODIGO_DO_PARCEIRO,\r\n    'BR' as Locale,\r\n    A.HC_Mes_Inicio__c,\r\n    A.HC_Mes_Fim__c,\r\n    A.HC_Quantidade_de_clientes_sorteados__c,\r\n    A.HC_Valor_do_premio__c,\r\n    /* evitar repetição de CPFs */\r\n\t\tROW_NUMBER() OVER(ORDER BY B.HC_CPF_CNPJ__C ASC) AS ROWNO\r\n  FROM (\r\n    SELECT\r\n      A.ID as CAMPAIGNID,\r\n      B.ID AS CLIENTEPARCEIROID,\r\n      C.ID AS CONTACTID,\r\n      row_number() over (PARTITION BY B.ID ORDER BY B.ID) AS ROW\r\n    FROM CAMPAIGN_SALESFORCE A\r\n    INNER JOIN HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE B ON 1 = 1\r\n    INNER JOIN CONTACT_SALESFORCE C ON C.HC_CPF_CNPJ__C = B.HC_CPF_CNPJ__C\r\n    INNER JOIN HC_TITULO__C_SALESFORCE D ON D.HC_CLIENTE_X_PARCEIRO__C = B.ID\r\n    where \r\n      /* ------- CONFIG DA CAMPANHA ------- */\r\n      A.ID = '7016g000000NVZVAA4'\r\n      AND A.ISACTIVE = 1\r\n          /* Data de Execução */\r\n      AND CONVERT(VARCHAR(10), A.HC_DATA_DE_EXECUCAO__C, 101) = CONVERT(VARCHAR(10), GETDATE(), 101)\r\n      AND DATEPART(HH, A.HC_DATA_DE_EXECUCAO__C) = DATEPART(HH, GETDATE())\r\n          /* Tipo de cliente controlado pela campanha */\r\n      AND (B.HC_TIPO_DE_PESSOA__C = A.HC_TIPO_DE_CLIENTE__C OR (A.HC_TIPO_DE_CLIENTE__C = 'PF E PJ' ))\r\n      /* ------- CONFIG DE TITULO ------- */\r\n      AND D.HC_SITUACAO__C = 'ATIVO'\r\n      /* ------- CONFIG DE CLIENTE PARCEIRO ------- */\r\n      AND B.HC_NAO_DESEJA_RECEBER_TODOS_MEIOS__C = 0\r\n      AND (ISNULL(B.HC_NAO_IMPORTUNE__C, 0) = 0 OR A.HC_VALIDA_NAO_IMPORTUNE__C = 0)\r\n          /* Pode receber comunicação por algum canal (E-mail ou SMS) */\r\n      AND (\r\n        /* Pode receber e-mail */\r\n        ( ISNULL(B.HC_NAO_DESEJA_RECEBER_EMAIL__C, 0) = 0 AND ( B.HC_EMAIL_BRASILCAP__C IS NOT NULL OR B.HC_EMAIL_COMERCIAL__C IS NOT NULL OR B.HC_EMAIL_PESSOAL__C IS NOT NULL ) )\r\n        /* ou pode receber sms */\r\n        OR ( ISNULL(B.HC_NAO_DESEJA_RECEBER_SMS__C, 0) = 0 AND (B.HC_STATUS_CELULAR_1__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_2__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_3__C = 'VÁLIDO' \r\n          OR B.HC_STATUS_CELULAR_3_3__C = 'VÁLIDO' OR B.HC_STATUS_CELULAR_4__C = 'VÁLIDO') )\r\n      )\r\n      AND B.HC_CLASSIFICACAO__C = 'Cliente'\r\n      AND B.HC_NOME_PARCEIRO__C = 'BB CORRETORA'\r\n    ) SELECTED\r\n    INNER JOIN CAMPAIGN_SALESFORCE A ON SELECTED.CAMPAIGNID = A.ID\r\n    INNER JOIN HC_RELACAO_CLIENTE_PARCEIRO__C_SALESFORCE B ON SELECTED.CLIENTEPARCEIROID = B.ID\r\n    INNER JOIN CONTACT_SALESFORCE C ON SELECTED.CONTACTID = C.ID\r\n  WHERE SELECTED.ROW = 1\r\n) BASE\r\nINNER JOIN\r\n  CAMPAIGN_SALESFORCE CAMP\r\n  ON BASE.ID_CAMPANHA = CAMP.ID\r\nWHERE\r\n\tCAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C IS NULL\r\n\tOR BASE.ROWNO <= (CAMP.HC_QUANTIDADE_DE_CONTATOS_NO_MAILING__C)",
  "targetName": "Tb_SorteioPeriodico",
  "targetKey": "2AA8BDAF-20B6-4AF9-927D-76428F521D83",
  "targetId": "ed054452-6af5-eb11-a30d-48df37342c99",
  "targetDescription": "",
  "createdDate": "2021-08-05T16:30:19.17",
  "modifiedDate": "2022-06-21T15:47:51.893",
  "targetUpdateTypeId": 0,
  "targetUpdateTypeName": "Overwrite",
  "categoryId": 37898,
  "isFrozen": false
}
SELECT
  Idade,
  Compra_Recente_Ourocap,
  Cliente_PEP,
  Nome,
  Id,
  Nao_Importune,
  Possui_Conta_Ativa,
  Id_Contato,
  Dt_Inicio_Mailing,
  Tipo_Pessoa,
  Sexo,
  Possui_Telefone_Ativo,
  Data_Proxima_Execucao,
  Conselheiro,
  Deseja_Contato_Telefonico,
  Idade_Valida,
  Meses_Compra_Exclusao,
  Id_Cliente_Parceiro,
  Dt_Fim_Mailing,
  Meses_Quarentena_Exclusao,
  Quarentena,
  Dt_Nascimento,
  CPF_CNPJ,
  Parceiro,
  NAO_DESEJA_RECEBER_SMS,
  NAO_DESEJA_RECEBER_EMAIL,
  EMAIL,
  EMAIL_VALIDO,
  CELULAR,
  CELULAR_VALIDO,
  ID_CAMPANHA,
  HC_renovacao_automatica__c,
  TITULO_ID,
  CreatedDate,
  Flag_WhatsApp
  from (
  SELECT row_number() OVER (PARTITION BY 1 ORDER BY CreatedDate DESC) AS RANK,
  Idade,
  Compra_Recente_Ourocap,
  Cliente_PEP,
  Nome,
  Id,
  Nao_Importune,
  Possui_Conta_Ativa,
  Id_Contato,
  Dt_Inicio_Mailing,
  Tipo_Pessoa,
  Sexo,
  Possui_Telefone_Ativo,
  Data_Proxima_Execucao,
  Conselheiro,
  Deseja_Contato_Telefonico,
  Idade_Valida,
  Meses_Compra_Exclusao,
  Id_Cliente_Parceiro,
  Dt_Fim_Mailing,
  Meses_Quarentena_Exclusao,
  Quarentena,
  Dt_Nascimento,
  CPF_CNPJ,
  Parceiro,
  NAO_DESEJA_RECEBER_SMS,
  NAO_DESEJA_RECEBER_EMAIL,
  EMAIL,
  EMAIL_VALIDO,
  CELULAR,
  CELULAR_VALIDO,
  ID_CAMPANHA,
  HC_renovacao_automatica__c,
  TITULO_ID,
  CreatedDate,
  REPLACE(Flag_WhatsApp, 0, 1) AS Flag_WhatsApp
FROM
  AeM_Fim_Plano_PU_semOTC_Filtrado
WHERE CELULAR_VALIDO = 1) A
WHERE RANK <= (500 - (SELECT COUNT(1) FROM AeM_Fim_Plano_PU_semOTC_Historico WHERE CONVERT(date, CreatedDate) = CONVERT(date, GETDATE())))